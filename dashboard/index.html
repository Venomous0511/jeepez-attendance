<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RFID Attendance Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <nav>
    <ul class="nav-bar"
      style="display: flex; list-style: none; padding: 0; margin: 0; background-color: #0D2364; justify-content: center;">
      <li style="margin: 0;"><button class="nav-btn active" data-target="register"
          style="padding: 15px 30px; margin: 0 5px; background: rgba(255,255,255,0.1); color: white; border: none; cursor: pointer;">Register</button>
      </li>
      <li style="margin: 0;"><button class="nav-btn" data-target="logs"
          style="padding: 15px 30px; margin: 0 5px; background: transparent; color: white; border: none; cursor: pointer;">Attendance
          Logs</button></li>
      <li style="margin: 0;"><button class="nav-btn" data-target="userData"
          style="padding: 15px 30px; margin: 0 5px; background: transparent; color: white; border: none; cursor: pointer;">Registered
          Users</button></li>
    </ul>
  </nav>

  <section id="register" class="page active">
    <h2>Register New User</h2>
    <form id="registerForm">
      <label for="name">Name</label>
      <input type="text" name="name" required />
      <label for="uid">UID</label>
      <input type="text" name="uid" required minlength="6" maxlength="20" pattern="[A-Fa-f0-9]{6,20}"
        placeholder="E.g., A386FB2" />
      <label for="gender">Gender</label>
      <select name="gender" id="gender" required style="color:#9aa3b2;"
        onchange="this.style.color = this.value ? '#222' : '#9aa3b2';">
        <option value="" disabled selected hidden>Select your gender</option>
        <option value="Male" style="color:#222;">Male</option>
        <option value="Female" style="color:#222;">Female</option>
        <option value="Other" style="color:#222;">Other</option>
      </select>

      </select>
      <label for="email">Email</label>
      <input type="email" name="email" required placeholder="user@example.com" />
      <label for="phoneNumber">Phone Number</label>
      <input type="tel" name="phoneNumber" required pattern="^\+63\d{10}$" placeholder="+639XXXXXXXXX" />
      <button type="submit">Register</button>
    </form>
  </section>

  <section id="logs" class="page">
    <h2>Attendance Logs</h2>

    <div class="table-search">
      <input type="text" id="searchLog" placeholder="Search name..." class="table-search-input" />
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>UID</th>
          <th>Tap Type</th>
          <th>Time</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="logsTable"></tbody>
    </table>
  </section>

  <section id="userData" class="page">
    <h2>Registered Users</h2>
    <table style="width: 100%;">
      <div class="table-search">
        <input type="text" id="searchRegistered" placeholder="Search by name or UID..." class="table-search-input" />
      </div>

      <thead>
        <tr>
          <th style="width: 250px;">Name</th>
          <th style="width: 100px;">UID</th>
          <th>Gender</th>
          <th>Email</th>
          <th>Phone</th>
          <th style="width: 200px;">Actions</th>
        </tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>
  </section>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // For local development
    // const SERVER_URL = 'http://localhost:3000';

    // For production
    // const SERVER_URL = 'https://jeepez-attendance.onrender.com';

    // For auto-detecting server URL
    const SERVER_URL = 'window.location.origin';

    const socket = io(SERVER_URL);

    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-btn').forEach(b => {
          b.classList.remove('active');
          b.style.background = 'transparent';
        });
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

        btn.classList.add('active');
        btn.style.background = 'var(--hover-color)';
        document.getElementById(btn.dataset.target).classList.add('active');
      });
    });

    // Listen for real-time log updates
    socket.on("newLog", (log) => {
      console.log('Real-time log received:', log);
      appendLog(log);
    });

    socket.on("new-log", (log) => {
      console.log('Real-time log received (old format):', log);
      appendLog(log);
    });

    function appendLog(log) {
      const tbody = document.getElementById('logsTable');

      const logName = log.name || 'Unknown';
      const logType = log.type || 'unknown';
      const logUid = log.uid || 'N/A';
      const logTimestamp = log.timestamp || new Date();
      const logDate = log.date || new Date(logTimestamp).toLocaleDateString('en-US');

      const formattedTime = new Date(logTimestamp).toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
      });

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${logName}</td>
        <td>${logUid}</td>
        <td>${logType.toUpperCase()}</td>
        <td>${formattedTime}</td>
        <td>${logDate}</td>
      `;
      tbody.prepend(row);
    }

    socket.on('connect', () => {
      console.log('Connected to server for real-time updates');
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from server');
    });

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const name = form.name.value.trim();
      const uid = form.uid.value.trim().toUpperCase();
      const gender = form.gender.value;
      const email = form.email.value.trim();
      const phoneNumber = form.phoneNumber.value.trim();

      // Validation
      if (!name) {
        alert('Name is required and cannot be empty.');
        return;
      }

      if (!uid) {
        alert('UID is required and cannot be empty.');
        return;
      }

      if (uid.length !== 7) {
        alert(`UID must be exactly 7 characters long. You entered ${uid.length} characters: "${uid}"`);
        return;
      }

      if (!/^[0-9A-F]{6,20}$/.test(uid)) {
        const invalidChars = uid.split('').filter(char => !/[A-F0-9]/.test(char));
        alert(`UID can only contain hexadecimal characters (0-9, A-F). Invalid characters found: "${invalidChars.join(', ')}"`);
        return;
      }

      if (!email) {
        alert('Email is required and cannot be empty.');
        return;
      }

      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert(`Invalid email format. Please enter a valid email like "user@example.com". You entered: "${email}"`);
        return;
      }

      if (!phoneNumber) {
        alert('Phone number is required and cannot be empty.');
        return;
      }

      if (!/^\+63\d{10}$/.test(phoneNumber)) {
        if (!phoneNumber.startsWith('09')) {
          alert(`Phone number must start with "+63". You entered: "${phoneNumber}"`);
        } else if (phoneNumber.length !== 13) {
          alert(`Phone number must be exactly 11 digits. You entered ${phoneNumber.length} digits: "${phoneNumber}"`);
        } else {
          alert(`Phone number contains invalid characters. Only digits 0-9 allowed. You entered: "${phoneNumber}"`);
        }
        return;
      }

      const user = { name, uid, gender, email, phoneNumber };

      try {
        const res = await fetch(`${SERVER_URL}/api/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(user)
        });
        const data = await res.json();

        if (res.ok) {
          alert('User registered successfully!');
          form.reset();
          loadUsers();
        } else {
          if (data.message) {
            if (data.message.includes('duplicate key error') || data.message.includes('E11000')) {
              if (data.message.includes('uid')) {
                alert(`Registration failed: UID "${uid}" is already registered to another user.`);
              } else if (data.message.includes('email')) {
                alert(`Registration failed: Email "${email}" is already registered to another user.`);
              } else if (data.message.includes('phoneNumber')) {
                alert(`Registration failed: Phone number "${phoneNumber}" is already registered to another user.`);
              } else {
                alert(`Registration failed: Duplicate data found. ${data.message}`);
              }
            } else if (data.message.includes('validation failed')) {
              alert(`Registration failed: ${data.message}`);
            } else {
              alert(`Registration failed: ${data.message}`);
            }
          } else {
            alert(`Registration failed with status ${res.status}. Please check your input and try again.`);
          }
        }
      } catch (error) {
        console.error('Error during registration:', error);
        alert(`Network error: Unable to connect to server. Please check your internet connection and try again. Error: ${error.message}`);
      }
    });

    async function loadUsers() {
      try {
        const res = await fetch(`${SERVER_URL}/api/users`);
        const users = await res.json();
        const tbody = document.getElementById('userTable');
        tbody.innerHTML = '';
        users.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.name}</td>
            <td>${user.uid}</td>
            <td>${user.gender}</td>
            <td>${user.email}</td>
            <td>${user.phoneNumber}</td>
            <td>
              <button class="save-btn" onclick="editUser('${user._id}')">Edit</button>
              <button class="delete-btn" onclick="deleteUser('${user._id}')">Delete</button>
            </td>
          `;
          tbody.prepend(row);
        });
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    async function deleteUser(id) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      try {
        const res = await fetch(`${SERVER_URL}/api/users/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (res.ok) {
          alert('User deleted successfully');
          loadUsers();
        } else {
          alert(data.message || 'Failed to delete user');
        }
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('An unexpected error occurred while deleting the user.');
      }
    }

    function editUser(id) {
      window.location.href = `/dashboard/edit.html?id=${id}`;
    }

    document.getElementById('searchRegistered').addEventListener('input', function () {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll('#userTable tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
      });
    });

    async function loadLogs() {
      try {
        const res = await fetch(`${SERVER_URL}/api/logs`);
        const logs = await res.json();

        // Sort logs by timestamp descending (latest first)
        logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        const tbody = document.getElementById('logsTable');
        tbody.innerHTML = '';
        logs.reverse().forEach(log => appendLog(log));
      } catch (error) {
        console.error('Error loading logs:', error);
      }
    }

    document.getElementById('searchLog').addEventListener('input', function () {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll('#logsTable tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
      });
    });

    loadUsers();
    loadLogs();
  </script>
</body>

</html>